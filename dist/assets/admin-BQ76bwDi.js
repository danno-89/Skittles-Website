import"./modulepreload-polyfill-B5Qt9EMX.js";import{e as B,c as T,b as f,q as N,w as C,h as ne,u as H,d as E,g as q,T as Q,m as be,n as Te,p as xe,r as ie}from"./firebase.config-IpTQKhZm.js";/* empty css             */import{a as Be}from"./main-DLzLBIiP.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";let R=[],ee=new Map,_=new Map;async function fe(){try{const t=N(T(f,"match_results"),C("status","==","completed"),ne("scheduledDate","desc"));R=(await B(t)).docs.map(n=>({id:n.id,...n.data()}))}catch(t){console.error("Error fetching completed fixtures:",t)}}async function De(){try{(await B(T(f,"players_public"))).forEach(e=>ee.set(e.id,{id:e.id,...e.data()}))}catch(t){console.error("Error fetching players:",t)}}async function Ce(){try{(await B(T(f,"teams"))).forEach(e=>_.set(e.id,e.data().name))}catch(t){console.error("Error fetching teams:",t)}}function we(){const t=document.getElementById("edit-date-select");if(!t)return;t.innerHTML='<option value="">Select a date</option>',[...new Set(R.map(n=>n.scheduledDate.toDate().toISOString().split("T")[0]))].forEach(n=>{const i=document.createElement("option");i.value=n,i.textContent=new Date(n).toLocaleString("en-GB",{weekday:"short",day:"numeric",month:"short"}),t.appendChild(i)})}function Le(){const t=document.getElementById("edit-date-select"),e=document.getElementById("edit-match-select"),n=document.getElementById("edit-results-form-container");t&&(t.addEventListener("change",()=>{e.innerHTML='<option value="">Select a match</option>',e.disabled=!0,n.style.display="none",R.filter(a=>a.scheduledDate.toDate().toISOString().split("T")[0]===t.value).forEach(a=>{const s=_.get(a.homeTeamId),l=_.get(a.awayTeamId),o=a.scheduledDate.toDate().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),c=document.createElement("option");c.value=a.id,c.textContent=`${s} vs ${l} (${o})`,e.appendChild(c)}),e.disabled=!1}),e.addEventListener("change",async()=>{n.style.display="none";const i=e.value,a=R.find(s=>s.id===i);if(a){document.getElementById("edit-home-team-name-header").textContent=_.get(a.homeTeamId),document.getElementById("edit-away-team-name-header").textContent=_.get(a.awayTeamId),document.getElementById("edit-home-bowled-first").value=a.homeTeamId,document.getElementById("edit-away-bowled-first").value=a.awayTeamId,a.bowledFirst===a.homeTeamId?document.getElementById("edit-home-bowled-first").checked=!0:document.getElementById("edit-away-bowled-first").checked=!0;const s=document.getElementById("edit-home-team-scorecard"),l=document.getElementById("edit-away-team-scorecard");await re(a.homeTeamId,s,ee,a.homeScores),await re(a.awayTeamId,l,ee,a.awayScores),Y(s,document.getElementById("edit-home-team-total-display")),Y(l,document.getElementById("edit-away-team-total-display")),n.style.display="block"}}),document.getElementById("submit-edited-results-btn").addEventListener("click",async()=>{var p;const i=e.value,a=R.find(d=>d.id===i),s=d=>Array.from(document.querySelectorAll(`#${d} tbody tr`)).map(r=>({playerId:r.querySelector(".player-select").value,hands:Array.from(r.querySelectorAll(".hand-score")).map(m=>parseInt(m.value)||0),score:parseInt(r.querySelector(".total-score-col").textContent)})).filter(r=>r.playerId&&r.hands.length===5),l=s("edit-home-team-scorecard"),o=s("edit-away-team-scorecard"),c=(p=document.querySelector('input[name="edit-bowled-first"]:checked'))==null?void 0:p.value,h=[];if(l.length<6&&h.push("Home team has incomplete scores."),o.length<6&&h.push("Away team has incomplete scores."),c||h.push("Please select which team bowled first."),h.length>0){alert(`Please correct the following issues:

- `+h.join(`
- `));return}const u={homeScore:parseInt(document.getElementById("edit-home-team-total-display").textContent),awayScore:parseInt(document.getElementById("edit-away-team-total-display").textContent),homeScores:l,awayScores:o,bowledFirst:c,status:"completed"};try{await Ae(a),await H(E(f,"match_results",i),u),await $e(a,u),alert("Results updated and league table adjusted successfully!"),await fe(),we(),e.innerHTML='<option value="">Select a match</option>',e.disabled=!0,n.style.display="none"}catch(d){console.error("Error submitting edited results:",d),alert("An error occurred while submitting the edited results.")}}))}async function re(t,e,n,i){if(!e)return;const a=Array.from(n.values()).filter(o=>o.teamId===t);e.innerHTML=`
        <thead>
            <tr>
                <th class="player-name-col">Player</th>
                <th>H1</th><th>H2</th><th>H3</th><th>H4</th><th>H5</th>
                <th class="total-score-col">Total</th>
            </tr>
        </thead>
        <tbody>
            ${i.map(o=>`
                <tr>
                    <td class="player-name-col">
                        <select class="player-select">
                            <option value="">Select player</option>
                            <option value="sixthPlayer">6th Player</option>
                            ${a.map(c=>`<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join("")}
                        </select>
                    </td>
                    ${o.hands.map(c=>`<td class="hand-score-col"><input type="number" class="hand-score" min="0" max="27" value="${c}"></td>`).join("")}
                    <td class="total-score-col">${o.score}</td>
                </tr>
            `).join("")}
        </tbody>`;const s=e.querySelectorAll(".player-select");i.forEach((o,c)=>{s[c]&&(s[c].value=o.playerId)});const l=()=>{const o=Array.from(s).map(c=>c.value).filter(c=>c&&c!=="sixthPlayer");s.forEach(c=>{const h=c.value;Array.from(c.options).forEach(u=>{u.value&&u.value!=="sixthPlayer"&&u.value!==h&&(o.includes(u.value)?u.style.display="none":u.style.display="block")})})};s.forEach(o=>{o.addEventListener("change",()=>{Y(e,e.id.includes("home")?document.getElementById("edit-home-team-total-display"):document.getElementById("edit-away-team-total-display")),l()})}),l(),e.addEventListener("input",o=>{if(o.target.classList.contains("hand-score")){const c=o.target.closest("tr");if(c){const h=Array.from(c.querySelectorAll(".hand-score")).map(p=>parseInt(p.value)||0);c.querySelector(".total-score-col").textContent=h.reduce((p,d)=>p+d,0);const u=e.id.includes("home")?document.getElementById("edit-home-team-total-display"):document.getElementById("edit-away-team-total-display");u&&Y(e,u)}}})}function Y(t,e){if(!t||!e)return;const n=Array.from(t.querySelectorAll("tbody .total-score-col")).map(i=>parseInt(i.textContent)||0);e.textContent=n.reduce((i,a)=>i+a,0)}async function Ae(t){var w;const{homeTeamId:e,awayTeamId:n,division:i,season:a,homeScore:s,awayScore:l}=t;let o,c;s>l?(o={result:"won",points:2},c={result:"lost",points:0}):l>s?(o={result:"lost",points:0},c={result:"won",points:2}):(o={result:"drawn",points:1},c={result:"drawn",points:1});const h=E(f,"league_tables",a),u=await q(h);if(!u.exists()){console.error(`League table for season ${a} not found.`);return}const d=((w=u.data()[i])==null?void 0:w.standings)||[],r=(I,S,b,L)=>{const g=d.findIndex(y=>y.teamId===I);if(g!==-1){const y=d[g];y.played-=1,y.won-=S.result==="won"?1:0,y.lost-=S.result==="lost"?1:0,y.drawn-=S.result==="drawn"?1:0,y.points-=S.points,y.pinsFor-=b,y.pinsAgainst-=L,d[g]=y}};r(e,o,s,l),r(n,c,l,s);const m={[`${i}.standings`]:d};await H(h,m)}async function $e(t,e){const{homeTeamId:n,awayTeamId:i,division:a,season:s}=t,{homeScore:l,awayScore:o}=e;let c,h;l>o?(c={result:"won",points:2},h={result:"lost",points:0}):o>l?(c={result:"lost",points:0},h={result:"won",points:2}):(c={result:"drawn",points:1},h={result:"drawn",points:1});const u=E(f,"league_tables",s),p=await q(u);if(!p.exists()){console.error(`League table for season ${s} not found.`);return}const d=p.data();d[a]||(d[a]={leagueName:a.replace(/_/g," ").replace(/\b\w/g,I=>I.toUpperCase()),standings:[]});const r=d[a].standings||[],m=(I,S,b,L)=>{let g=r.findIndex(D=>D.teamId===I);g===-1&&(r.push({teamId:I,teamName:_.get(I)}),g=r.length-1);const y=r[g];y.played=(y.played??0)+1,y.won=(y.won??0)+(S.result==="won"?1:0),y.lost=(y.lost??0)+(S.result==="lost"?1:0),y.drawn=(y.drawn??0)+(S.result==="drawn"?1:0),y.points=(y.points??0)+S.points,y.pinsFor=(y.pinsFor??0)+b,y.pinsAgainst=(y.pinsAgainst??0)+L,(!y.max_score||b>y.max_score)&&(y.max_score=b),r[g]=y};m(n,c,l,o),m(i,h,o,l);const w={[`${a}.standings`]:r};await H(u,w)}async function ke(){await Ce(),await De(),await fe(),we(),Le()}let te=[],ae;const v={postponedSelect:null,dateInput:null,timeInput:null,rescheduleBtn:null,feedbackDiv:null};async function Pe(){const t=N(T(f,"match_results"),C("status","==","postponed"));te=(await B(t)).docs.map(n=>({id:n.id,...n.data()})),te.sort((n,i)=>n.scheduledDate.toMillis()-i.scheduledDate.toMillis())}function Me(){v.postponedSelect.innerHTML='<option value="">1. Select Fixture to Move</option>',te.forEach(t=>{const e=ae.get(t.homeTeamId)||"Unknown",n=ae.get(t.awayTeamId)||"Unknown",i=t.scheduledDate.toDate().toLocaleDateString("en-GB"),a=document.createElement("option");a.value=t.id,a.textContent=`${i} - ${e} vs ${n}`,v.postponedSelect.appendChild(a)})}function O(){v.rescheduleBtn.disabled=!(v.postponedSelect.value&&v.dateInput.value&&v.timeInput.value)}async function Fe(){const t=v.postponedSelect.value,e=v.dateInput.value,n=v.timeInput.value;if(!t||!e||!n){j("Please select a fixture and enter a new date and time.","error");return}const[i,a,s]=e.split("-").map(Number),[l,o]=n.split(":").map(Number),c=new Date(i,a-1,s,l,o);if(confirm("Are you sure you want to reschedule this fixture to the new date and time?")){v.rescheduleBtn.disabled=!0,j("Rescheduling fixture...","info");try{const u=E(f,"match_results",t);await H(u,{scheduledDate:Q.fromDate(c),status:"rescheduled"}),j("Fixture rescheduled successfully!","success"),await ge()}catch(u){console.error("Error updating fixture:",u),j(`An error occurred: ${u.message}`,"error")}finally{O()}}}function j(t,e){v.feedbackDiv.textContent=t,v.feedbackDiv.className=`feedback-message ${e}`,v.feedbackDiv.style.display="block"}async function ge(){await Pe(),Me(),v.dateInput.value="",v.timeInput.value="",O()}function Ne(t){if(ae=t,v.postponedSelect=document.getElementById("postponed-fixture-select"),v.dateInput=document.getElementById("new-date-input"),v.timeInput=document.getElementById("new-time-input"),v.rescheduleBtn=document.getElementById("reschedule-submit-btn"),v.feedbackDiv=document.getElementById("reschedule-feedback"),!v.postponedSelect||!v.dateInput||!v.timeInput||!v.rescheduleBtn){console.error("Reschedule fixture tab elements not found!");return}v.postponedSelect.addEventListener("change",O),v.dateInput.addEventListener("change",O),v.timeInput.addEventListener("change",O),v.rescheduleBtn.addEventListener("click",Fe),ge()}async function He(){const t=document.getElementById("news-form"),e=document.getElementById("news-list"),n=document.getElementById("news-id");async function i(){if(!e)return;e.innerHTML="<h3>Existing News</h3>";const a=N(T(f,"news"),ne("timestamp","desc"));(await B(a)).forEach(l=>{const o=l.data(),c=document.createElement("div");c.classList.add("news-item"),c.innerHTML=`
                <h3>${o.title}</h3>
                <p>${o.content}</p>
                <div class="news-item-actions">
                    <button class="btn btn-secondary edit-news-btn" data-id="${l.id}">Edit</button>
                    <button class="btn btn-danger delete-news-btn" data-id="${l.id}">Delete</button>
                </div>
            `,e.appendChild(c)})}t.addEventListener("submit",async a=>{a.preventDefault();const s=document.getElementById("news-title").value,l=document.getElementById("news-content").value,o=n.value;o?await H(E(f,"news",o),{title:s,content:l}):await be(T(f,"news"),{title:s,content:l,timestamp:xe()}),t.reset(),n.value="",i()}),e.addEventListener("click",async a=>{if(a.target.classList.contains("edit-news-btn")){const s=a.target.dataset.id,l=E(f,"news",s),c=(await getDoc(l)).data();document.getElementById("news-title").value=c.title,document.getElementById("news-content").value=c.content,n.value=s}if(a.target.classList.contains("delete-news-btn")){const s=a.target.dataset.id;confirm("Are you sure you want to delete this news item?")&&(await Te(E(f,"news",s)),i())}}),i()}let W=new Map,G=[],le=!1;async function _e(){if(le)return;const t=document.getElementById("correction-season-select"),e=document.getElementById("correction-division-select"),n=document.getElementById("generate-table-btn"),i=document.getElementById("correction-container"),a=document.getElementById("current-table"),s=document.getElementById("corrected-table"),l=document.getElementById("confirm-update-btn");!t||!e||!n||(await qe(),await Re(t,e),t.addEventListener("change",()=>ve(t.value,e)),n.addEventListener("click",()=>Oe(t.value,e.value,i,a,s,l)),l.addEventListener("click",()=>ze(t.value,e.value)),le=!0)}async function qe(){(await B(T(f,"teams"))).forEach(e=>W.set(e.id,e.data().name))}async function Re(t,e){const n=await B(T(f,"league_tables")),i=[...new Set(n.docs.map(a=>a.id))].sort((a,s)=>s.localeCompare(a));t.innerHTML='<option value="">Select a Season</option>',i.forEach(a=>{const s=document.createElement("option");s.value=a,s.textContent=a.replace("-"," - "),t.appendChild(s)}),i.length>0&&(t.value=i[0],await ve(i[0],e))}async function ve(t,e){if(e.innerHTML='<option value="">Select a Division</option>',!t)return;const n=E(f,"league_tables",t),i=await q(n);if(i.exists()){const a=i.data();Object.keys(a).filter(l=>l!=="season").map(l=>({id:l,name:a[l].leagueName||l})).sort((l,o)=>l.name.localeCompare(o.name)).forEach(l=>{const o=document.createElement("option");o.value=l.id,o.textContent=l.name,e.appendChild(o)})}else console.error(`League document for season ${t} not found.`)}async function Oe(t,e,n,i,a,s){if(!t||!e){alert("Please select a season and division.");return}n.style.display="block",s.style.display="none";const l=await We(t,e);de(l,i);const o=await Ue(t,e);G=je(o,l),de(G,a,"Corrected",l);const c=(p,d)=>(p.id||p.teamId).localeCompare(d.id||d.teamId),h=JSON.stringify(l.map(p=>({...p,teamName:void 0})).sort(c)),u=JSON.stringify(G.map(p=>({...p,teamName:void 0})).sort(c));h!==u&&(s.style.display="block")}async function We(t,e){const n=E(f,"league_tables",t),i=await q(n);if(i.exists()){const a=i.data();if(a[e]&&a[e].standings)return a[e].standings.map(s=>({...s,id:s.teamId,teamName:W.get(s.teamId)||"Unknown"}))}return[]}async function Ue(t,e){const n=N(T(f,"match_results"),C("season","==",t),C("division","==",e),C("status","==","completed"));return(await B(n)).docs.map(a=>a.data())}function je(t,e){const n=new Map;return e.forEach(i=>{const a=i.id||i.teamId;n.set(a,{id:a,played:0,won:0,drawn:0,lost:0,points:0,pinsFor:0,pinsAgainst:0})}),t.forEach(i=>{const{homeTeamId:a,awayTeamId:s,homeScore:l,awayScore:o}=i,c=n.get(a),h=n.get(s);if(!c||!h)return;let u=0,p=0,d="lost",r="lost";l>o?(u=2,d="won"):o>l?(p=2,r="won"):(u=1,p=1,d="drawn",r="drawn"),ce(c,d,u,l,o),ce(h,r,p,o,l)}),Array.from(n.values())}function ce(t,e,n,i,a){t.played++,e==="won"&&t.won++,e==="drawn"&&t.drawn++,e==="lost"&&t.lost++,t.points+=n,t.pinsFor+=i,t.pinsAgainst+=a}function de(t,e,n,i=null){const a=document.createElement("table");a.className="league-standings-table",a.innerHTML="<thead><tr><th>Team</th><th>Pld</th><th>W</th><th>D</th><th>L</th><th>Pts</th><th>PF</th><th>PA</th></tr></thead><tbody></tbody>";const s=a.querySelector("tbody");[...t].sort((o,c)=>c.points-o.points||c.pinsFor-c.pinsAgainst-(o.pinsFor-o.pinsAgainst)||(W.get(o.id)||"").localeCompare(W.get(c.id)||"")).forEach(o=>{const c=document.createElement("tr"),h=W.get(o.id)||"Unknown";if(c.innerHTML=`
            <td>${h}</td>
            <td>${o.played}</td>
            <td>${o.won}</td>
            <td>${o.drawn}</td>
            <td>${o.lost}</td>
            <td>${o.points}</td>
            <td>${o.pinsFor}</td>
            <td>${o.pinsAgainst}</td>
        `,i){const u=i.find(p=>p.id===o.id);if(u){const p=(d,r,m)=>{r>m?d.classList.add("highlight-increase"):r<m&&d.classList.add("highlight-decrease")};p(c.cells[1],o.played,u.played),p(c.cells[2],o.won,u.won),p(c.cells[3],o.drawn,u.drawn),p(c.cells[4],o.lost,u.lost),p(c.cells[5],o.points,u.points),p(c.cells[6],o.pinsFor,u.pinsFor),p(c.cells[7],o.pinsAgainst,u.pinsAgainst)}}s.appendChild(c)}),e.innerHTML="",e.appendChild(a)}async function ze(t,e){const n=E(f,"league_tables",t);try{const i=G.map(s=>{const{teamName:l,...o}=s;return{...o,teamId:s.id}}),a={};a[`${e}.standings`]=i,await H(n,a),alert("League table updated successfully!"),document.getElementById("correction-container").style.display="none"}catch(i){console.error("Error updating league table:",i),alert("An error occurred while updating the league table.")}}const x=new Map;let M=[],z=new Map,U={};document.addEventListener("DOMContentLoaded",()=>{Be.then(({user:t,publicData:e})=>{const n=document.getElementById("tab-content-container");if(!n){console.error("Admin page content container not found.");return}t&&(e!=null&&e.committee)?Ge():n.innerHTML="<p>You do not have the necessary permissions to view this page.</p>"})});async function Ge(){try{await Qe(),await J(),await Ye(),Ke(),Xe(),Ve(),ke(),Ne(x),He(),_e()}catch(t){console.error("An error occurred during admin page initialisation:",t);const e=document.getElementById("tab-content-container");e&&(e.innerHTML="<p>A critical error occurred while loading the admin page. Please try again later.</p>")}}async function Qe(){(await B(T(f,"teams"))).forEach(e=>x.set(e.id,e.data().name))}async function J(){const t=N(T(f,"match_results"),C("status","in",["scheduled","rescheduled"]),ne("scheduledDate"));M=(await B(t)).docs.map(n=>({id:n.id,...n.data()}))}async function Ye(){(await B(T(f,"players_public"))).forEach(n=>z.set(n.id,{id:n.id,public:n.data()})),(await B(T(f,"players_private"))).forEach(n=>{z.has(n.id)?z.get(n.id).private=n.data():z.set(n.id,{id:n.id,private:n.data()})})}async function Je(t){try{const e=E(f,"ssc_cup",t),n=await q(e);n.exists()?U=n.data().teamAverages||{}:(console.warn(`No ssc_cup data found for season: ${t}`),U={})}catch(e){console.error("Error fetching team averages:",e),U={}}}async function Z(t,e){const n=document.getElementById(e);if(n){if(!t){n.textContent="";return}try{const i=E(f,"competitions",t),a=await q(i);a.exists()?n.textContent=a.data().name:n.textContent="Competition details not found."}catch(i){console.error("Error fetching competition name:",i),n.textContent="Error loading competition name."}}}function Ke(){const t=document.getElementById("admin-tabs-container"),e=document.getElementById("tab-content-container");if(!t||!e){console.error("Tab containers not found. Tab functionality will be disabled.");return}const n=t.querySelectorAll(".tab-link"),i=e.querySelectorAll(".tab-pane");n.forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.tab;n.forEach(l=>l.classList.remove("active")),a.classList.add("active"),i.forEach(l=>{l.classList.toggle("active",l.id===`${s}-content`)})})})}function Ve(){const t=document.getElementById("postpone-fixture-form");if(!t)return;const e=document.getElementById("fixture-to-postpone-select"),n=document.getElementById("postponing-team-select"),i=document.getElementById("postponement-date-input"),a=document.getElementById("postpone-fixture-status");!e||!n||!i||!a||(e.addEventListener("change",()=>{n.innerHTML='<option value="">Which team postponed?</option>',n.disabled=!0;const s=M.find(l=>l.id===e.value);if(s){const l=x.get(s.homeTeamId)||"Unknown",o=x.get(s.awayTeamId)||"Unknown";n.innerHTML+=`<option value="${s.homeTeamId}">${l}</option>`,n.innerHTML+=`<option value="${s.awayTeamId}">${o}</option>`,n.disabled=!1}}),t.addEventListener("submit",async s=>{s.preventDefault();const{value:l}=e,{value:o}=n,{value:c}=i;if(!l||!o||!c){a.textContent="Please fill out all fields.",a.className="status-error";return}try{await H(E(f,"match_results",l),{status:"postponed",postponedBy:o,postponedDate:Q.fromDate(new Date(c))}),a.textContent="Fixture successfully postponed!",a.className="status-success",t.reset(),n.disabled=!0,await J(),ue()}catch(h){console.error("Error postponing fixture:",h),a.textContent="An error occurred. Please try again.",a.className="status-error"}}),ue())}function ue(){const t=document.getElementById("fixture-to-postpone-select");t&&(t.innerHTML='<option value="">Select a fixture to postpone</option>',M.forEach(e=>{const n=x.get(e.homeTeamId)||"Unknown",i=x.get(e.awayTeamId)||"Unknown",a=e.scheduledDate.toDate().toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}),s=document.createElement("option");s.value=e.id,s.textContent=`${a} - ${n} vs ${i}`,t.appendChild(s)}))}function Xe(){const t=document.getElementById("date-select"),e=document.getElementById("match-select"),n=document.getElementById("results-form-container"),i=document.getElementById("submit-results-btn"),a=document.getElementById("walkover-select"),s=document.getElementById("walkover-form-container"),l=document.getElementById("submit-walkover-btn"),o=document.getElementById("walkover-winner"),c=document.getElementById("walkover-score");if(!t||!e||!n||!i||!a||!s){console.error("One or more elements for results input are missing.");return}let h=new Map;const u=async()=>{(await B(T(f,"players_public"))).forEach(r=>{const m=r.data();h.set(r.id,{id:r.id,name:`${m.firstName} ${m.lastName}`,teamId:m.teamId})})},p=()=>{t.innerHTML='<option value="">Select a date</option>';const d=[...new Set(M.map(r=>r.scheduledDate.toDate().toISOString().split("T")[0]))];d.sort((r,m)=>new Date(r)-new Date(m)),d.forEach(r=>{const m=document.createElement("option");m.value=r,m.textContent=new Date(r).toLocaleString("en-GB",{weekday:"short",day:"numeric",month:"short"}),t.appendChild(m)})};t.addEventListener("change",()=>{e.innerHTML='<option value="">Select a match</option>',n.style.display="none",Z(null,"competition-name");const d=M.filter(r=>r.scheduledDate.toDate().toISOString().split("T")[0]===t.value);d.forEach(r=>{const m=x.get(r.homeTeamId),w=x.get(r.awayTeamId),I=r.scheduledDate.toDate().toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),S=document.createElement("option");S.value=r.id,S.textContent=`${m} vs ${w} (${I})`,e.appendChild(S)}),e.disabled=!d.length}),e.addEventListener("change",async()=>{n.style.display="none";const d=M.find(r=>r.id===e.value);if(d){a.innerHTML='<option value="">Match Played</option>';const r=x.get(d.homeTeamId),m=x.get(d.awayTeamId),w=document.createElement("option");w.value="home",w.textContent=`Walkover: ${r} (Home Win)`,a.appendChild(w);const I=document.createElement("option");I.value="away",I.textContent=`Walkover: ${m} (Away Win)`,a.appendChild(I),a.disabled=!1,a.value="",s.style.display="none",await Z(d.division,"competition-name"),d.division==="ssc-cup"&&await Je(d.season),document.getElementById("home-team-name-header").textContent=x.get(d.homeTeamId),document.getElementById("away-team-name-header").textContent=x.get(d.awayTeamId),document.getElementById("home-bowled-first").value=d.homeTeamId,document.getElementById("away-bowled-first").value=d.awayTeamId,me("home",d,h),me("away",d,h),n.style.display="block"}else Z(null,"competition-name")}),a.addEventListener("change",async()=>{const d=M.find(r=>r.id===e.value);if(d)if(a.value==="")n.style.display="block",s.style.display="none";else{n.style.display="none",s.style.display="block";const r=a.value==="home"?d.homeTeamId:d.awayTeamId,m=x.get(r);o.textContent=m,c.textContent="Calculating...";const w=await Ze(r,d.season,d.division);c.textContent=w}}),l.addEventListener("click",async()=>{const d=e.value,r=a.value,m=M.find(b=>b.id===d);if(!m||!r){alert("Error: Invalid walkover selection.");return}const w=r==="home"?m.homeTeamId:m.awayTeamId,I=parseInt(c.textContent)||0,S={homeScore:r==="home"?I:0,awayScore:r==="away"?I:0,homeScores:[],awayScores:[],bowledFirst:null,status:"completed",walkover:!0,note:r==="home"?"Home Walkover":"Away Walkover"};if(confirm(`Confirm Walkover: ${x.get(w)} wins with ${I} points?`))try{await ie(f,async b=>{let L,g,y,D;["premier-division","first-division"].includes(m.division)?(L=E(f,"league_tables",m.season),g=await b.get(L)):m.division==="ssc-cup"&&(y=E(f,"ssc_cup",m.season),D=await b.get(y));const F=E(f,"match_results",d);let k,A;if(L&&g.exists()){const P=g.data();P[m.division]&&P[m.division].standings&&(k=ye(m,S,P[m.division].standings))}if(y&&D.exists()&&(A=he(m,S,D.data())),b.update(F,S),k){const P=`${m.division}.standings`;b.update(L,{[P]:k})}A&&b.update(y,A)}),alert("Walkover submitted successfully!"),await J(),p(),n.style.display="none",s.style.display="none"}catch(b){console.error("Error submitting walkover:",b),alert("An error occurred while submitting walkover.")}}),i.addEventListener("click",async()=>{var L;const d=e.value,r=g=>Array.from(document.querySelectorAll(`#${g} tbody tr`)).map(y=>{if(y.id.endsWith("-handicap-row"))return null;const D=y.querySelector(".player-select").value,F=Array.from(y.querySelectorAll(".hand-score")).map(A=>parseInt(A.value)||0),k=F.reduce((A,P)=>A+P,0);return{playerId:D,hands:F,score:k}}).filter(y=>y&&y.playerId&&y.hands.length===5),m=r("home-team-scorecard"),w=r("away-team-scorecard"),I=(L=document.querySelector('input[name="bowled-first"]:checked'))==null?void 0:L.value,S=[];if(m.length<6&&S.push("Home team has incomplete scores."),w.length<6&&S.push("Away team has incomplete scores."),I||S.push("Please select which team bowled first."),S.length>0){alert(`Please correct the following issues:

- `+S.join(`
- `));return}const b={homeScore:parseInt(document.getElementById("home-team-total-display").textContent),awayScore:parseInt(document.getElementById("away-team-total-display").textContent),homeScores:m,awayScores:w,bowledFirst:I,status:"completed"};try{const g=M.find(y=>y.id===d);await ie(f,async y=>{let D,F,k,A;["premier-division","first-division"].includes(g.division)?(D=E(f,"league_tables",g.season),F=await y.get(D)):g.division==="ssc-cup"&&(k=E(f,"ssc_cup",g.season),A=await y.get(k));const P=E(f,"match_results",d),oe=new Set([...m.map($=>$.playerId),...w.map($=>$.playerId)]);oe.delete("sixthPlayer");const se=g.scheduledDate.toDate(),Ie=Q.fromDate(se),K=new Date(se);K.setFullYear(K.getFullYear()+1);const Se=Q.fromDate(K);let V,X;if(D&&F.exists()){const $=F.data();$[g.division]&&$[g.division].standings&&(V=ye(g,b,$[g.division].standings))}if(k&&A.exists()&&(X=he(g,b,A.data())),y.update(P,b),V){const $=`${g.division}.standings`;y.update(D,{[$]:V})}X&&y.update(k,X);for(const $ of oe){const Ee=E(f,"players_public",$);y.update(Ee,{recentFixture:Ie,registerExpiry:Se})}}),alert("Results submitted successfully!"),await J(),p(),n.style.display="none"}catch(g){console.error("Error submitting results:",g),alert("An error occurred while submitting results.")}}),(async()=>(await u(),p()))()}function me(t,e,n){const i=document.getElementById(`${t}-team-scorecard`),a=e[`${t}TeamId`],s=Array.from(n.values()).filter(u=>u.teamId===a),l=u=>{const p=Array.from(i.querySelectorAll(".player-select")).map(r=>r.value),d=u.value;u.innerHTML='<option value="">Select player</option><option value="sixthPlayer">6th Player</option>',s.forEach(r=>{if(!p.includes(r.id)||r.id===d){const m=document.createElement("option");m.value=r.id,m.textContent=r.name,u.appendChild(m)}}),u.value=d};let o="",c=0;if(e.division==="ssc-cup"){const u=U[e.homeTeamId]||0,p=U[e.awayTeamId]||0,d=Math.round(Math.abs(u-p)*.95);(t==="home"&&u<p||t==="away"&&p<u)&&(c=d),c>0&&(o=`
                <tr id="${t}-handicap-row">
                    <td class="player-name-col"><strong>Handicap</strong></td>
                    <td colspan="5"></td>
                    <td class.total-score-col">${c}</td>
                </tr>
            `)}i.innerHTML=`
        <thead>
            <tr>
                <th class="player-name-col">Player</th>
                <th>H1</th><th>H2</th><th>H3</th><th>H4</th><th>H5</th>
                <th class="total-score-col">Total</th>
            </tr>
        </thead>
        <tbody>
            ${Array(6).fill().map(()=>`
                <tr>
                    <td class="player-name-col"><select class="form-select player-select"></select></td>
                    ${Array(5).fill().map(()=>'<td class="hand-score-col"><input type="number" class="hand-score" min="0" max="27"></td>').join("")}
                    <td class="total-score-col">0</td>
                </tr>
            `).join("")}
            ${o}
        </tbody>`;const h=i.querySelectorAll(".player-select");h.forEach(l),i.addEventListener("change",u=>{u.target.classList.contains("player-select")&&h.forEach(p=>{p!==u.target&&l(p)})}),i.addEventListener("input",u=>{if(u.target.classList.contains("hand-score")){const p=u.target.closest("tr"),d=Array.from(p.querySelectorAll(".hand-score")).map(r=>parseInt(r.value)||0);p.querySelector(".total-score-col").textContent=d.reduce((r,m)=>r+m,0),pe(i,c)}}),pe(i,c)}function pe(t,e=0){const i=Array.from(t.querySelectorAll('tbody tr:not([id*="-handicap-row"]) .total-score-col')).map(s=>parseInt(s.textContent)||0).reduce((s,l)=>s+l,0)+e,a=t.id.includes("home")?document.getElementById("home-team-total-display"):document.getElementById("away-team-total-display");a.textContent=i}function ye(t,e,n){const{homeTeamId:i,awayTeamId:a}=t,{homeScore:s,awayScore:l,bowledFirst:o}=e,c=n.find(r=>r.teamId===i),h=n.find(r=>r.teamId===a);let u=0,p=0;s>l?u=2:l>s?p=2:(u=1,p=1),e.walkover||(o===i&&s<l?u++:o===a&&l<s&&p++);const d=(r,m,w,I)=>{r.played=(r.played||0)+1,r.won=(r.won||0)+(m>=2?1:0),r.drawn=(r.drawn||0)+(m===1?1:0),r.lost=(r.lost||0)+(m<1?1:0),r.points=(r.points||0)+m,r.pinsFor=(r.pinsFor||0)+w,r.pinsAgainst=(r.pinsAgainst||0)+I};return c&&d(c,u,s,l),h&&d(h,p,l,s),n}function he(t,e,n){const{homeTeamId:i,awayTeamId:a,round:s}=t,{homeScore:l,awayScore:o}=e,c=s.replace("Group Stage - ","Group_"),h=n[c],u=h.standings.find(w=>w.teamName===i),p=h.standings.find(w=>w.teamName===a);let d=0,r=0;l>o?d=2:o>l?r=2:(d=1,r=1);const m=(w,I)=>{w.played=(w.played||0)+1,w.won=(w.won||0)+(I===2?1:0),w.drawn=(w.drawn||0)+(I===1?1:0),w.lost=(w.lost||0)+(I===0?1:0),w.points=(w.points||0)+I};return u&&m(u,d),p&&m(p,r),n[c]=h,n}async function Ze(t,e,n){try{const i=N(T(f,"match_results"),C("season","==",e),C("division","==",n),C("status","in",["completed","walkover"])),a=N(T(f,"match_results"),C("season","==",e),C("division","==",n),C("status","==","completed")),s=await B(a);let l=0,o=0;return s.forEach(c=>{const h=c.data();h.walkover||(h.homeTeamId===t?(l+=h.homeScore,o++):h.awayTeamId===t&&(l+=h.awayScore,o++))}),o===0?0:Math.round(l/o)}catch(i){return console.error("Error calculating average score:",i),0}}
